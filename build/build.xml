<?xml version="1.0" encoding="UTF-8"?>
<project name="walnut" default="run" basedir=".">
	<description>
       Walnut library build file
    </description>
	<!-- set global properties for this build -->
	<property environment="env" />

	<property name="JAVA_HOME" value="${env.JAVA_HOME}" />
	<property name="DEPS" value="${env.DEPS}" />
	<property name="DEST" value="${env.OUTPUT}" />
	<property name="PROJECT_HOME" value="${env.PROJECT_HOME}" />

	<property name="SRC" location="${PROJECT_HOME}/src" />
	<property name="EXT" location="${PROJECT_HOME}/ext" />
	<property name="TMP" value="${PROJECT_HOME}/build/temp" />

	<property name="JDK_VERSION" value="1.7" />


	<property name="v" value="1.2" />

	<path id="CLASSPATH">
		<fileset dir="${DEPS}" casesensitive="no">
			<include name="**/*.jar" />
		</fileset>
		<pathelement location="${JAVA_HOME}/lib/rt.jar" />
	</path>

	<target name="compile-core">
	    <mkdir dir="${TMP}" />
		<javac srcdir="${SRC}" destdir="${TMP}" debuglevel="lines,vars,source" debug="true" 
			source="${JDK_VERSION}" target="${JDK_VERSION}" 
			encoding="UTF-8" listfiles="off"
			includeantruntime="false"
			fork="true">
			<compilerarg value="-Xlint:all" />
			<classpath refid="CLASSPATH" />
		</javac>
		<copy todir="${TMP}">
			<fileset dir="${SRC}" excludes="**/*.java" />
		</copy>
	</target>

	<target name="jar-core" depends="compile-core">
		<echo message="TMP: ${TMP}" />
		<jar destfile="${DEST}/walnut-${v}.jar" 
			 basedir="${TMP}"
			 includes="**" />
		<jar destfile="${DEST}/walnut-${v}-source.jar"
					 basedir="${SRC}"
				     includes="**"/>
	</target>
	
	<path id="CLASSPATH2">
        <fileset dir="${DEPS}" casesensitive="no">
            <include name="**/*.jar" />
        </fileset>
        <pathelement location="${JAVA_HOME}/lib/rt.jar" />
        <pathelement location="${DEST}/walnut-${v}.jar" />
    </path>
	
	<target name="compile-ext" depends="jar-core">
	    <delete dir="${TMP}" />
	    <mkdir dir="${TMP}" />
        <javac srcdir="${EXT}" destdir="${TMP}" debuglevel="lines,vars,source" debug="true" 
            source="${JDK_VERSION}" target="${JDK_VERSION}" 
            encoding="UTF-8" listfiles="off"
            includeantruntime="false"
            fork="true">
            <compilerarg value="-Xlint:all" />
            <classpath refid="CLASSPATH2" />
        </javac>
        <copy todir="${TMP}">
            <fileset dir="${SRC}" excludes="**/*.java" />
        </copy>
    </target>

    <target name="jar-ext" depends="compile-ext">
        <echo message="TMP: ${TMP}" />
        <jar destfile="${DEST}/walnut-ext-${v}.jar" 
             basedir="${TMP}"
             includes="**" />
        <jar destfile="${DEST}/walnut-ext-${v}-source.jar"
                     basedir="${EXT}"
                     includes="**"/>
    </target>

	<target name="run" depends="jar-ext">
		<delete dir="${TMP}" />
	</target>
</project>
