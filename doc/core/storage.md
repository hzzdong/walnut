---
title: 数据存储
author: zozoh
tags:
- 系统
- 数据存储
---

# 多样化的数据存储

1. 系统底层认为每个 *WnObj* 都可以有一个存储
2. 存储被认为是一个接口
3. 一个对象的数据应该可以被散列到不同的物理机上

# 存储句柄

```
hdl ->  obj  -> {..}      # 对象的索引
        mode = R|W|RW     # 句柄打开类型
        off  = 0          # 打开针对对象原有数据何处进行操作
                          # 对于写操作，-1 表示在结尾追加
        unit = 1024       # 缓冲区每个数据块的大小
        posr = 0          # 针对 swap 读操作的位置
        posw = 0          # 针对 swap 写操作的位置
        swap -> [1U]      # 每块是一个数据单位，可以随用随申请
                [1U]      # 只有写操作才会
                 ..  
        create_time       # 句柄创建的时间
        last_modified     # 句柄最后一次被访问的时间

        cache_sha1        # 作为一个缓存，它的数据指纹
        last_access       # 作为一个缓存，它最后一次被命中的时间
        match_count       # 作为一个缓存，它被命中的次数
        refer_count       # 作为一个缓存，它被引用的次数
        reuse -> hld2     # 如果是 R && 0，复用的句柄，会增加 hdl2 的引用计数
```

# 天然的缓存

1. 如果 hdl 的 `off==0 && mode == "R"`，那么当它被关闭后，系统并不会归还它的 *swap*。
2. 除非写操作完成后，会置空所有的缓存句柄的 *swap* 字段
3. 那么当所有的引用者使用完毕后，缓存句柄也会被关闭
4. 下次有同样 `R && 0` 的操作时，会优先复用这个对象的缓存句柄















