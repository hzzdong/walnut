---
title:数据导出导入
author:wendal
tags:
- 系统
- 运维
---

# 设计动机

厚朴项目的数据需要"备份"功能, 同理, strato, woodpeax服务器也需要

按wendal最初的想法,是打包bucket数据目录及mongodb导出dump文件,也是当前厚朴服务器的做法.

然而,这种"硬"备份有很多问题:

* 不支持增量备份,虽然bucket目录可以做增量,但mongodb的数据不能.
* 不支持局部备份,即单独备份walnut内的指定目录树
* 存在bucket数据与mongodb dump数据不匹配的可能性
* 不能工作在集群环境下

为了解决上述的问题, 需要设计一套基于WnIo接口的导入导出机制

# 导出

数据分成2部分, WnObj(元数据)和bucket数据(文件数据)

其中objs目录存放WnObj数据, 根据walnut中的真实目录结构进行存放, 这样设计的原因是可以手工编辑.

但目录对象需要特殊命名 *_dir_$name.wobj*

```
objs
	- _dir_root.wobj
	- root
		- _dir_www.obj
		- www
			- index.html
			- login.html
```

而存放文件数据的bucket目录, 与LocalFileBucket实现的目录结构一致, 即

$sha1[0:2]/$sha1[2:]/$part

例如 sha1=vv3hb5m0t8ionrai3di3eh98s2, 然后它有3个分片,那么数据存储如下

```
bucket
	- vv
		- 3hb5m0t8ionrai3di3eh98s2
			- 0 
			- 1
			- 2
```

上述2个文件夹,打包压缩之后,就是一个数据导出包(或者叫备份包)

### 增量备份

在第一次完整导出后(基线备份包/完整备份包), 后续导出使用增量方式(增量备份包)

增量更新需要解决的问题:

* 文件新增
* 文件删除
* 文件夹变文件,或文件变文件夹

逐一解决:

* 文件新增 , 那么wobj数据肯定新增
* 文件删除, 需要一个标示文件 *_deleted_$name.wobj*
* 文件夹变文件,或文件变文件夹, 这种情况似乎判断一下就好了.

还有一种, 文件移动, 视为新增+删除的组合.

### 增量备份的生成过程

以基线备份包及后续的N个增量备份包为蓝本, 生成当前系统的增量备份包

* 第一轮, 根据历史备份数据,生成最后一个备份的目录树
* 第二轮, 根据当前目录树与备份目录的差异,生成增量备份目录树(objs目录)
* 第三轮, 根据增量备份目录树, 生成sha1列表,从而导出bucket目录

### 增量备份的合并执行过程

以基线备份包及后续的N个增量备份包为蓝本, 合成一个新的基线备份包(完整备份包)

* 第一轮, 合并wobj和bucket目录, 通过删除冲突文件的方式, 解决*文件夹变文件,或文件变文件夹*的问题
* 第二轮, 遍历*_deleted_$name.wobj*文件,删除指定wobj文件
* 第三轮, 遍历wobj目录,记录sha1, 然后清理bucket文件夹

# 导入

id是否需要保持原本的id? 遇到冲突怎么解决?