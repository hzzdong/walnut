---
title:新用户注册流程
author:zozoh
---

# 微信注册/登录

```
U : 用户
S : 云服务
X : 微信服务

# 具体流程
1. U -> S : 请求登录页面  # /u/h/login.html
2. U -> S : 选择微信登录，会弹出微信二维码
3. U -> X : 扫描二维码
4. X -> S : 验证通过，通知服务器
5. S -> U : 创建会话 ID

# 补充信息
6. S -> U : 如果没有用户名，弹出用户名收集页面 # /u/h/rename.html
7. U -> S : 填写最新的用户名
8. S -> U : 改名完成，打开主界面 # /a/open
```

# 手机注册

```
U : 用户
S : 云服务

# 具体流程
1. U -> S : 请求注册页面  # /u/h/signup.html
3. U -> S : 提供手机号
4. S -> U : 下发验证码
5. U -> S : 发送手机号，验证码，以及密码
6. S -> U : 创建会话 ID

# 补充信息
7. S -> U : 如果没有用户名，进入用户名修改页面 # /u/h/rename.html
8. U -> S : 填写最新的用户名
9. S -> U : 改名完成，打开主界面 # /a/open
```

由于手机号注册，是在创建用户之前，所以应该在系统预先存放验证码

```
/var/vcode/mobile
    13910445672        # 文件名就是手机号
```

一个验证码文件的元数据格式:

```
nm    : "13910445672"    # 文件名就是手机号
expi  : 1478..           # 验证码文件过期时间，通常为 10min
// 短信验证
sms_vcode  : "xxxx"        # 短信验证码
sms_vnext  : 1433..        # 过了这个时间，才能再次取得验证码
sms_vexpi  : 14339..       # 短信验证码有效期至（绝对毫秒数）
sms_retry  : {             # 验证码重试次数
    retry : 2   // 已经验证的次数
    maxre : 5   // 最多验证多少次 
}
```

# 邮箱注册

```
U : 用户
S : 云服务
E : 邮件服务器

# 具体流程
1. U -> S : 请求注册页面  # /u/h/signup.html
3. U -> S : 提供邮箱，以及密码
4. S -> E : 发送邮件验证码
5. S -> U : 提示用户到邮箱收取邮件
6. U -> S : 点击激活链接，或者输入验证码
7. S -> U : 创建会话 ID

# 补充信息
8. S -> U : 如果没有用户名，进入用户名修改页面 # /u/h/rename.html
9. U -> S : 填写最新的用户名
a. S -> U : 改名完成，打开主界面 # /a/open
```

# 用户名注册

```
U : 用户
S : 云服务

# 具体流程
1. U -> S : 请求注册页面  # /u/h/signup.html
2. U -> S : 提供登录名，以及密码
3. S -> U : 创建会话 ID

# 补充信息
3. S -> U : 进入用户设置界面 # /a/open/profile
4. U -> S : 可以自由选择进入手机，邮箱，微信绑定流程
```







