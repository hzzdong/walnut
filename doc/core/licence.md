---
title:许可证机制
author:zozoh
tags:
- 系统
- 支付
- 许可证
---


# 什么是许可证

在 walnut 上，从服务提供的角度，可以有下面三种角色

1. 系统 (walnut)
2. 服务提供方
3. 使用者

所谓许可证，就是服务提供方在自己的域构建一系列许可证数据，包括各种自定义的权限字段。使用者通过服务提供方的服务，将一个激活码保存到自己的域中，从而享有许可证允许的权限。

服务提供方在自己的提供的 app 里面也对使用者的许可证进行验证

如果对方的许可证激活码到期，服务提供方可以拒绝服务。当然用户可以用系统提供的免费应用浏览管理自己的数据，比如 `wn.console` 比如 `wn.browser`

# 许可证的数据结构

```
/app
    wn.hmaker            # 某个应用
        app_licence      # 本应用需要的许可证信息，没有这个文件则表示可以任意使用        
/home
    redfox                # 服务提供商域
        .licence          # 存放所有的公开许可证
            abc.licence   # 某一个许可证，可以随意命名
            bbc.licence   # 另外一个许可证
        .acode            # 存放许可证的激活码
            $ID1.acode    # 激活码就是一个 UUID
            $ID2.acode    # 激活码有很多
    xiaobai               # 使用者
        .app_licence      # 存放使用者得到的许可证激活码
            wn.hmaker.code     # 一个应用只能有一份许可证
            wn.ztask.code      # 使用者可以拥有多个不同应用
```

## 文件 app_licence

JSON 文件内容

```
{
    // 哪个域可以发放本应用的许可证
    provider : "DomainName1",
    
    // 是否支持自动发放体验版许可证
    auto_acode : {
        day     : 30,     // 有效期（天），0 表示不限时
        licence : "abc"   // 对应许可证
    }
}
```

## 文件 .licence

```
{
   // 具体这个 JSON 对象的内容，由 APP 自行定义
   // 原则上就是一组名值对
}
```

## 文件 .acode

无内容，仅有元数据

```
id         : "xxx"        // 唯一标识符
//.............................................
ac_day     : 0            // 有效天数
ac_licence : "abc"        // 对应本域的哪个许可证
ac_app     : "wn.hmaker"  // 对应哪个 app
//.............................................
// 激活码类型
//  auto - 自动生成
//  gen  - 手动生成
ac_tp      : "auto|gen"
//.............................................
// 激活码状态
//   0 - 未使用
//   1 - 已使用
//  -1 - 作废
ac_st      : 0
//.............................................
// 用户信息
ow_dmn_id  : ID        // 属于哪个域 ID
ow_dmn_nm  : xxx       // 「冗余」所属域名
buyer_id   : ID        // 购买者 ID，
buyer_nm   : xxx       // 「冗余」购买者 nm
buy_time   : MS        // 购买时间
use_time   : MS        // 生效时间
//.............................................
// 截止日期，null 或者 0 表示永不过期
// 这个字段当用户第一次使得这个激活码生效时，固定下来
// 是根据 usr_time 和 ac_day 自动计算的
ac_expi    : MS
//.............................................
// 支付信息
// 如果是用户主动购买，那么还会关联一条支付记录
// 关于支付，请参见系统的 paymen 的介绍
// 当然这个信息不是必须，仅仅作为关联使用
ac_payment : ID
```

## 文件 .code

普通文件而已，内容是 acode 文件的 ID。当然，其有效性是根据 App 里面的 `app_licence` 文件的限制来的，具体如何限制，请参见下文

# 许可证验证的流程

```
```

* `WnLicenceService` 将封装这个验证流程的核心逻辑
* `AppModule` 将针对每个 App 的打开，执行这个逻辑
* `cmd_licence` 将封装这个流程，以便测试



