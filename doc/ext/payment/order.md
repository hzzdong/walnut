---
title:订单支付流程
author:pw
tags:
- 系统
- 支付
---

# 支付完整流程

// TODO 

# 商户（域）

1. 任何一个域都可以变成商户(具有贩卖商品的能力)
2. 商户需遵守一定的规约

在域信息添加商户信息：

```
{
    .....             # 域本身信息
    store_nm          # 商户名称
    store_desp        # 商户描述
    
}
```

# 商品

1. 任何域都可以提供商品
2. 商品被选中后可以生成一条订单，然后进入订单流程
3. 商品可以被分享给其他渠道商（域）以供销售
4. 多个商品可以加入到一个商品包中，然后商品包控制覆盖部分属性


```
{
    id    : ID,              # 商品唯一标示
    tp    : "goods"          # 类型一定是 goods
    race  : "FILE"           # 一定是文件
    thumb : ID               # 商品缩略图
    //...........................................
    w_th  : ID               # 商品所对应的 thing ID，可以得到更详细的介绍
    w_nm  : "xxxx"           # 商品名称，支持 i18n:xxx 格式
    w_price    : 34.50       # 商品价格，单位元
    w_currency : "RMB"       # 货币单位，默认 RMB
    //............................................ 以下可以被商品包覆盖
    w_expi : AMS             # 销售过期时间, 之后无法购买
    w_buy_min: 1             # 最少购买件数 不能小于1
    w_buy_max: 5             # 最多购买件数 小于min表示无限制
    .....
}
```

# 商品包

1. 多个商品放在一个商品包内，会有专门的页面对包内商品进行展示
2. 商品包的属性可以影响包内的商品，比如整体打折等，打包销售等
3. 商品包部分属性会覆盖包内商品

```
{
    tp    : "d-goods"        # 类型一定是 d-goods
    race  : "DIR"            # 一定是目录
    thumb : ID               # 商品包缩略图
    //...........................................
    w_nm  : "xxxx"           # 商品名称，支持 i18n:xxx 格式
    w_price    : 34.50       # 商品包价格，没有设置的话则根据包内商品自动计算
    w_price_off: 0.5         # 价格折扣，没有设置包价格的话，自动计算包内总值 * 折扣
    w_currency : "RMB"       # 货币单位，默认 RMB
    w_bundle   : false       # 是否打包销售，false可以单独选择，true则必须一起销售
    w_bundle_min: 1          # 打包销售，最少选择数量 不能小于1
    w_bundle_max: 0          # 打包销售，最多选择数量 小于min表示无限制
    //............................................ 以下可以覆盖包内商品
    w_expi : AMS             # 销售过期时间, 之后无法购买
    .....
}

PS：w_price，w_price_off 相互影响，设置一个两一个自动计算，以w_price为主

```

# 订单

订单存放位置：

```
/sys/order/
    /商户1(域)
        order_xxxxxx
        order_yyyyyy
    /商户2(域)
        order_xxxxxx
        order_yyyyyy  
```

订单生成，查询等命令有 *cmd_order* 实现


1. n件(n>0)商品可以组成一个订单
2. 订单内包含下单商品的必要信息（copy过来），之后商品修改不影响订单内商品信息
3. 订单作为用户消费的唯一标示
4. 订单有多个状态，不同状态可进行的操作不同


```
{
    tp    : "order"           # 类型一定是 order
    race  : "FILE"            # 一定是目录
    //........................................... 商品信息
    order_goods : [{              # 可以是商品，可以是商品包
        id: ID
        tp: "goods"
        w_nm  : "xxxx"            # 商品名称
        w_price    : 34.50        # 商品价格
        w_buy_num  : 1            # 购买数量
    },
    {
        id: ID
        tp: "d-goods"
        w_nm  : "xxxx"            # 商品名称
        w_price    : 34.50        # 商品价格
        w_buy_num  : 1            # 购买数量
        items: [{
          ....                    # 商品
        }]
    }],
    order_price    : 34.50       # 订单价格
    order_currency : "RMB"       # 订单货币单位
    store_id       : ID          # 商户域ID
    store_nm       : "xxxxx"     # 商户域名称
    //........................................... 购买人信息
    purchaser:     : ID          # 购买人
    purchaser_nm   : "xxxxx"     # 购买人名称
    //........................................... 支付信息
    order_status   : "xxxx"      # 订单状态 未支付->支付->消费
    order_expi     : AMS         # 订单过期时间
    
    // TODO
}
```


# 支付

1. 根据订单内容向支付通道发起请求
2. 订单更新，等待支付平台回调后修改订单状态
3. 订单状态修改，通知商户，购买者


// TODO



