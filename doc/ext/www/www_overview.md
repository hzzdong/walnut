---
title:www网页机制
author:zozoh
tags:
- 系统
- 扩展
- www
---

# www 发布目录

系统可以指定任意一个目录为 www 的发布目录，目录的 `www` 元数据指定浏览器访问的路径

* 标记了元数据 *www* 的目录为发布目录，它可以被浏览器直接访问
* 对于 `www="ROOT"` 的目录（大小写敏感）对应的超链接为 `http://$host/www/$grp/` 
* 对于 `www="abc"` 的目录（大小写敏感）对应的超链接为 `http://$host/www/$grp/abc` 
* 如果标记 *www* 的目录出现重名，那么系统会任意选择一个
* *www* 目录可存放
    - 网页模板 : *tp=wnml* - 会被解析渲染
    - 静态网页 : *tp=html* - 直接输出
    - 各种图片等媒体资源
    - js 文件
    - css 文件
    - 其他任何文件
* *www* 目录在通过浏览器直接访问的时候，会根据其设定来决定如何处理和限制访问权限
    - 即，通常的文件 IO 权限将被忽略
* 与 *httpapi* 配合，可以让网页获得更丰富的动态数据

# 目录的元数据

```
# 下述元数据将可以作用于目录或网页上

www        : "ROOT"       # 指明 www 访问的路径名。 通常只有顶级目录才有这个属性
www_entry  : [..]         # 指明目录下默认的主页，默认为 ["index.wnml", "index.html"]

```

# 网页模板语法

网页模板就是普通的 HTML，只不过支持一些自定的标签和属性

## 全局上下文

```
// 以下是每个网页模板都会得到上下文，这个上下文会被数据源扩展
{
    grp : "xxx"       # 提供网页服务器的 Walnut 用户组名
    fnm : "xxx"       # 网页的文件名
}
```

## 数据源

数据源可以对上下文进行补充

```
<script class="wn-datasource" name="obj" type="json">
obj ~/abc/*
</script>
```

* 数据源通过 `<script>` 标签，申明一段命令
* 如果 *type=json* 那么会认为命令的输出是一段 JSON 字符串，可以是对象也可以是列表
* 还支持的类型 *type=string* 表示输出的就是字符串
* 这个对象将根据 *name* 属性记录在上下文中
* 在输出到浏览器时，数据源节点将被移除
* 数据源按照声明的先后顺序逐次执行，后面的数据源会覆盖前面的数据内容
* 全局上下文的内容是最优先的，会覆盖数据源输出的上下文（如果重名的话）

## 静态引入 `<include>`

```
<include path="/path/to/file"/>
```

* 可以写在网页的任意地方，它都将引入目标文件
* 目标加入 DOM 后，将统一执行替换

## 文本占位符

```
<div class="my_${obj.type}">
    文本任意地方都可以插入占位符 ${pos.x} 
</div>
```

* 只有属性和文本节点支持占位符
* 占位符支持 `${obj.type(类型:格式)?默认值}` 的写法

## 判断 `<if>`

```
<if test="$EL">
    只有 $EL 为 true 的时候，下面的 DOM 才会被渲染，否则整个节点会被移除
</if>
```

## 循环 `<each>`

```
<each var="abc" items="obj.list">
    会在上下文中创建名为 abc 的对象，等退出循环就会删除掉
    如果 obj.list 不是一个集合或者数组，那么会当做对象循环一次
    其内的 DOM 节点会被循环输出
</each>
```

## 分支 `<choose>`

```
<choose>
    <when test="$EL">
        $EL 为真的时候输出其内内容
    </when>
    <otherwise>
        所有的 when 都不满足的时候，输出这里的内容
    </otherwise>
</choose>
```

























